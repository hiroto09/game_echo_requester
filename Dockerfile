# ------------------------------------------------------------
# ベースイメージ
# ------------------------------------------------------------
FROM python:3.11-slim

# ------------------------------------------------------------
# arping, nmap, setcap など必要パッケージをインストール
# ------------------------------------------------------------
RUN apt-get update \
 && apt-get install -y --no-install-recommends nmap arping libcap2-bin sudo \
 && rm -rf /var/lib/apt/lists/*

# ------------------------------------------------------------
# 作業ディレクトリ
# ------------------------------------------------------------
WORKDIR /app

# ------------------------------------------------------------
# 非rootユーザ作成
# ------------------------------------------------------------
RUN useradd -m -u 1000 -s /bin/bash app

# ------------------------------------------------------------
# arpingにcapability付与（root不要で実行できるようにする）
# ------------------------------------------------------------
RUN setcap 'cap_net_raw+ep' /usr/sbin/arping || true

# ------------------------------------------------------------
# sudo設定（nmapだけNOPASSWDで許可）
# ------------------------------------------------------------
RUN echo "app ALL=(ALL) NOPASSWD: /usr/bin/nmap" > /etc/sudoers.d/app \
 && chmod 0440 /etc/sudoers.d/app

# ------------------------------------------------------------
# Python依存パッケージ
# ------------------------------------------------------------
RUN pip install --no-cache-dir requests python-dotenv

# ------------------------------------------------------------
# アプリコードをコピー
# ------------------------------------------------------------
COPY . /app

# ------------------------------------------------------------
# 実行ユーザをappに切り替え
# ------------------------------------------------------------
USER app

# ------------------------------------------------------------
# メインスクリプト実行
# ------------------------------------------------------------
CMD ["python", "main.py"]
